<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>üè† ESP32 Smart Home Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto',sans-serif
        }

        body {
            background: linear-gradient(-45deg,#05142d,#08284b,#08386c,#0a4e80);
            background-size: 400% 400%;
            animation: bgmove 10s ease infinite;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column
        }

        @keyframes bgmove {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(6px)
        }

        h1 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .user-info {
            font-size: 0.9rem;
            color: #dbeef7
        }

        .logout {
            background: #f44;
            color: #fff;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: .3s
        }

            .logout:hover {
                background: #ff6666
            }

        .main {
            flex: 1;
            padding: 1.5rem 2rem;
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 1rem;
            align-items: start
        }

        @media(max-width:980px) {
            .main {
                grid-template-columns: 1fr
            }
        }

        .panel {
            background: rgba(255,255,255,0.03);
            padding: 1rem;
            border-radius: 12px;
            backdrop-filter: blur(6px)
        }

        .rooms {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
            gap: 1rem
        }

        .room {
            background: linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
            padding: 1rem;
            border-radius: 10px;
            transition: transform .2s;
            box-shadow: 0 6px 18px rgba(2,6,23,0.6)
        }

            .room:hover {
                transform: translateY(-6px)
            }

            .room h2 {
                margin-bottom: 0.6rem
            }

        .device {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem;
            border-radius: 8px;
            background: rgba(0,0,0,0.15);
            margin-bottom: 0.6rem
        }

        .indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #06121a;
            font-weight: 700
        }

            .indicator.off {
                background: #394651;
                color: #9fb0c9
            }

        .toggle {
            width: 46px;
            height: 26px;
            border-radius: 20px;
            background: #24323f;
            position: relative;
            cursor: pointer
        }

            .toggle::before {
                content: '';
                position: absolute;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #dbeef7;
                top: 4px;
                left: 4px;
                transition: all .18s
            }

            .toggle.on {
                background: linear-gradient(90deg,#22d18b,#00b894)
            }

                .toggle.on::before {
                    left: 24px;
                    background: #fff
                }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 0.8rem
        }

        .mqtt-toggle {
            margin-top: 1rem;
            text-align: center
        }

        .log {
            margin-top: 1rem;
            background: rgba(255,165,0,0.12);
            padding: 0.8rem;
            border-radius: 8px;
            max-height: 160px;
            overflow: auto;
            border-top: 3px solid rgba(255,165,0,0.6);
            font-size: 0.85rem
        }

            .log p {
                margin: 0.25rem 0;
                color: #fff
            }

        .temp-panel {
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 8px;
            text-align: center;
            background: rgba(0,255,255,0.08);
            box-shadow: 0 0 10px rgba(0,255,255,0.4);
            font-size: 0.9rem;
            color: #aefeff;
            font-weight: 600;
            transition: all .3s ease
        }

        .buzzer-pulse {
            animation: pulseRed 1.2s infinite alternate
        }

        @keyframes pulseRed {
            from {
                box-shadow: 0 0 6px #ff3333,0 0 12px #ff3333
            }

            to {
                box-shadow: 0 0 20px #ff0000,0 0 30px #ff0000
            }
        }

        .mqtt-status {
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .mqtt-connected {
            background: rgba(34, 209, 139, 0.2);
            color: #22d18b;
        }

        .mqtt-disconnected {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
    </style>
</head>
<body>
    <header>
        <h1>üè† ESP32 Smart Home Dashboard</h1>
        <div class="user-info" id="userInfo"></div>
        <button class="logout" id="logoutBtn">Logout</button>
    </header>

    <div class="main">
        <div class="panel">
            <div class="rooms" id="rooms"></div>
        </div>

        <div class="panel" style="display:flex;flex-direction:column;gap:12px">
            <div class="panel" style="padding:12px">
                <div style="font-size:0.95rem">Summary</div>
                <div id="summary" style="font-weight:700;font-size:1.3rem;margin-top:6px">0 ON</div>
            </div>
            <div id="mqttArea" class="panel" style="padding:12px;text-align:center">
                <div class="mqtt-status mqtt-disconnected" id="mqttStatus">üî¥ MQTT Disconnected</div>
            </div>
            <div class="panel" style="padding:12px">
                <div style="font-size:0.95rem;margin-bottom:6px">Activity Log</div>
                <div class="log" id="logBox"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        // ========================================
        // MQTT Configuration
        // ========================================
        const MQTT_BROKER_URL = "wss://broker.hivemq.com:8884/mqtt";
		const MQTT_TOPIC_CONTROL = "smarthome/control";
		const MQTT_TOPIC_STATUS = "smarthome/status";

		let mqttClient = null;
		let mqttConnected = false;

        // ========================================
        // User Info
        // ========================================
        const username = localStorage.getItem("username") || "Admin";
        const role = localStorage.getItem("role") || "admin";
        document.getElementById("userInfo").textContent = `${role.charAt(0).toUpperCase() + role.slice(1)} (${username})`;
        
        // ========================================
        // Device Data
        // ========================================
        const rooms = [
            { name: "Living Hall", devices: [{ id: "living_light", label: "Light", color: "#ff4d4d", state: false }, { id: "living_fan", label: "Fan", color: "#7f8cff", state: false }] },
            { name: "Kitchen", devices: [{ id: "kitchen_light", label: "Light", color: "#34d399", state: false }], temperature: 26.0 },
            { name: "Bedroom 1", devices: [{ id: "bed1_light", label: "Light", color: "#ffd166", state: false }, { id: "bed1_fan", label: "Fan", color: "#7f8cff", state: false }] },
            { name: "Bedroom 2", devices: [{ id: "bed2_light", label: "Light", color: "#b388eb", state: false }, { id: "bed2_fan", label: "Fan", color: "#7f8cff", state: false }] },
            { name: "Buzzer Control", devices: [{ id: "buzzer", label: "Buzzer", color: "#ff3333", state: false, isBuzzer: true }] }
        ];

        const logBox = document.getElementById("logBox");

        // ========================================
        // MQTT Connection
        // ========================================
        function connectMQTT() {
            const clientId = "SmartHomeDashboard_" + Math.random().toString(16).substr(2, 8);
            mqttClient = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientId);
            
            mqttClient.onConnectionLost = (response) => {
                mqttConnected = false;
                updateMQTTStatus(false);
                addLog("MQTT connection lost");
                setTimeout(connectMQTT, 5000);
            };
            
            mqttClient.onMessageArrived = (message) => {
                const payload = message.payloadString;
                addLog(`Received: ${payload}`);
                
                try {
                    const data = JSON.parse(payload);
                    updateDeviceStatesFromMQTT(data);
                } catch (e) {
                    console.log("Non-JSON message received");
                }
            };
            
			mqttClient.connect({
			useSSL: true,
			timeout: 5,
			onSuccess: () => {
				mqttConnected = true;
				updateMQTTStatus(true);
				addLog("MQTT connected successfully (HiveMQ Secure)");
				mqttClient.subscribe(MQTT_TOPIC_STATUS);
				addLog(`Subscribed to ${MQTT_TOPIC_STATUS}`);
			},
			onFailure: (error) => {
				mqttConnected = false;
				updateMQTTStatus(false);
				addLog(`MQTT connection failed: ${error.errorMessage}`);
				setTimeout(connectMQTT, 5000);
			}
			});
		}

        // ========================================
        // Update MQTT Status Display
        // ========================================
        function updateMQTTStatus(connected) {
            const statusEl = document.getElementById("mqttStatus");
            if (connected) {
                statusEl.textContent = "üü¢ MQTT Connected";
                statusEl.className = "mqtt-status mqtt-connected";
            } else {
                statusEl.textContent = "üî¥ MQTT Disconnected";
                statusEl.className = "mqtt-status mqtt-disconnected";
            }
        }

        // ========================================
        // Update Device States from MQTT
        // ========================================
        function updateDeviceStatesFromMQTT(data) {
            if (data.living_light !== undefined) {
                const device = findDevice("living_light");
                if (device) {
                    device.state = data.living_light === "on";
                    render();
                }
            }
            
            if (data.buzzer !== undefined) {
                const device = findDevice("buzzer");
                if (device) {
                    device.state = data.buzzer === "on";
                    render();
                }
            }
        }

        function findDevice(deviceId) {
            for (const room of rooms) {
                const device = room.devices.find(d => d.id === deviceId);
                if (device) return device;
            }
            return null;
        }

        // ========================================
        // Publish MQTT Command
        // ========================================
        function publishMQTT(command) {
            if (!mqttConnected) {
                addLog("‚ö†Ô∏è MQTT not connected - cannot send command");
                return false;
            }
            
            const message = new Paho.MQTT.Message(command);
            message.destinationName = MQTT_TOPIC_CONTROL;
            mqttClient.send(message);
            addLog(`üì§ Sent: ${command}`);
            return true;
        }

        // ========================================
        // Activity Log
        // ========================================
        function addLog(msg) {
            const t = new Date().toLocaleTimeString();
            logBox.innerHTML += `<p>[${t}] ${msg}</p>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        // ========================================
        // Render Devices
        // ========================================
        function render() {
            const roomsDiv = document.getElementById("rooms");
            roomsDiv.innerHTML = "";
            let on = 0, total = 0;
            
            rooms.forEach(r => {
                const card = document.createElement("div");
                card.className = "room";
                const h = document.createElement("h2");
                h.textContent = r.name;
                card.appendChild(h);
                
                r.devices.forEach(d => {
                    const dv = document.createElement("div");
                    dv.className = "device";
                    const ind = document.createElement("div");
                    ind.className = "indicator " + (d.state ? "" : "off");
                    ind.style.background = d.state ? d.color : "";
                    ind.textContent = d.label === "Light" ? "üí°" : d.isBuzzer ? "üîî" : "üåÄ";
                    
                    const lbl = document.createElement("div");
                    lbl.textContent = d.label;
                    
                    const tg = document.createElement("div");
                    tg.className = "toggle " + (d.state ? "on" : "");
                    
                    if (role === "guest") {
                        tg.style.pointerEvents = "none";
                        tg.style.opacity = 0.6;
                    } else {
                        tg.onclick = () => {
                            // Only send MQTT for living_light and buzzer (actual hardware)
                            if (d.id === "living_light" || d.id === "buzzer") {
                                const newState = !d.state;
                                const command = `${d.id}_${newState ? "on" : "off"}`;
                                
                                if (publishMQTT(command)) {
                                    // Update UI optimistically
                                    tg.classList.toggle("on");
                                    d.state = newState;
                                    ind.classList.toggle("off", !d.state);
                                    ind.style.background = d.state ? d.color : "";
                                    
                                    if (d.isBuzzer && d.state) {
                                        ind.classList.add("buzzer-pulse");
                                        setTimeout(() => {
                                            d.state = false;
                                            ind.classList.remove("buzzer-pulse");
                                            tg.classList.remove("on");
                                            ind.classList.add("off");
                                            ind.style.background = "";
                                        }, 2000);
                                    }
                                    
                                    addLog(`${d.state ? "turned ON" : "turned OFF"} ${r.name} ${d.label}`);
                                    updateSummary();
                                }
                            } else {
                                // Virtual devices (not connected to hardware)
                                tg.classList.toggle("on");
                                d.state = !d.state;
                                ind.classList.toggle("off", !d.state);
                                ind.style.background = d.state ? d.color : "";
                                addLog(`${d.state ? "turned ON" : "turned OFF"} ${r.name} ${d.label} (virtual)`);
                                updateSummary();
                            }
                        };
                    }
                    
                    dv.appendChild(ind);
                    dv.appendChild(lbl);
                    dv.appendChild(tg);
                    card.appendChild(dv);
                    total++;
                    if (d.state) on++;
                });
                
                // Temperature panel for Kitchen
                if (r.name === "Kitchen") {
                    const tempDiv = document.createElement("div");
                    tempDiv.className = "temp-panel";
                    tempDiv.id = "kitchenTemp";
                    tempDiv.textContent = `üå°Ô∏è ${r.temperature.toFixed(1)} ¬∞C`;
                    card.appendChild(tempDiv);
                }
                
                roomsDiv.appendChild(card);
            });
            
            updateSummary();
        }

        // ========================================
        // Update Summary
        // ========================================
        function updateSummary() {
            let on = 0, total = 0;
            rooms.forEach(r => r.devices.forEach(d => {
                total++;
                if (d.state) on++;
            }));
            const el = document.getElementById("summary");
            el.textContent = `${on} ON`;
            el.style.transition = "transform .2s";
            el.style.transform = "translateY(-6px)";
            setTimeout(() => el.style.transform = "", 200);
        }

        // ========================================
        // Temperature Simulation
        // ========================================
        function updateTemp() {
            const kitchen = rooms.find(r => r.name === "Kitchen");
            if (!kitchen) return;
            let newTemp = kitchen.temperature + (Math.random() - 0.5);
            kitchen.temperature = parseFloat(newTemp.toFixed(1));
            const el = document.getElementById("kitchenTemp");
            if (el) el.textContent = `üå°Ô∏è ${kitchen.temperature.toFixed(1)} ¬∞C`;
        }

        // ========================================
        // Logout
        // ========================================
        document.getElementById("logoutBtn").onclick = () => {
            if (mqttClient && mqttConnected) {
                mqttClient.disconnect();
            }
            localStorage.clear();
            location.href = "index.html";
        };

        // ========================================
        // Initialize
        // ========================================
        render();
        connectMQTT();
        setInterval(updateTemp, 10000);
    </script>
</body>
</html>