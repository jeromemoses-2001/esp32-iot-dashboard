<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>üè† ESP32 Smart Home Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif}
body{background:linear-gradient(-45deg,#05142d,#08284b,#08386c,#0a4e80);background-size:400% 400%;animation:bgmove 10s ease infinite;color:#fff;min-height:100vh;display:flex;flex-direction:column}
@keyframes bgmove{0%{background-position:0%50%}50%{background-position:100%50%}100%{background-position:0%50%}}
header{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:rgba(255,255,255,0.04);backdrop-filter:blur(6px)}
h1{font-size:1.2rem;display:flex;align-items:center;gap:10px}
.user-info{display:flex;align-items:center;gap:1rem}
.user-badge{display:flex;align-items:center;gap:0.5rem;background:rgba(255,255,255,0.1);padding:0.5rem 1rem;border-radius:8px;font-size:0.9rem}
.role-icon{font-size:1.2rem}
.logout{background:#f44;color:#fff;border:none;padding:.5rem 1.2rem;border-radius:.4rem;cursor:pointer;transition:.3s;font-weight:600}
.logout:hover{background:#ff6666;transform:translateY(-2px)}
.main{flex:1;padding:1.5rem 2rem;display:grid;grid-template-columns:1fr 360px;gap:1rem;align-items:start}
@media(max-width:980px){.main{grid-template-columns:1fr}}
.panel{background:rgba(255,255,255,0.03);padding:1rem;border-radius:12px;backdrop-filter:blur(6px)}
.rooms{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
.room{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:1rem;border-radius:10px;transition:transform .2s;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
.room:hover{transform:translateY(-6px)}
.room h2{margin-bottom:.6rem;font-size:1.1rem}
.device{display:flex;align-items:center;justify-content:space-between;padding:.6rem;border-radius:8px;background:rgba(0,0,0,0.15);margin-bottom:.6rem}
.indicator{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;color:#06121a;font-weight:700;transition:all .3s}
.indicator.off{background:#394651;color:#9fb0c9}
.toggle{width:46px;height:26px;border-radius:20px;background:#24323f;position:relative;cursor:pointer;transition:all .3s}
.toggle.disabled{opacity:0.4;cursor:not-allowed}
.toggle::before{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#dbeef7;top:4px;left:4px;transition:all .18s}
.toggle.on{background:linear-gradient(90deg,#22d18b,#00b894)}
.toggle.on::before{left:24px;background:#fff}
.toggle:hover:not(.disabled){transform:scale(1.05)}
.log{margin-top:1rem;background:rgba(255,165,0,0.12);padding:.8rem;border-radius:8px;max-height:160px;overflow:auto;border-top:3px solid rgba(255,165,0,0.6);font-size:.85rem}
.log p{margin:.25rem 0;color:#fff}
.temp-panel{margin-top:8px;padding:6px 10px;border-radius:8px;text-align:center;background:rgba(0,255,255,0.08);box-shadow:0 0 10px rgba(0,255,255,0.4);font-size:.9rem;color:#aefeff;font-weight:600;animation:tempGlow 2s ease-in-out infinite}
@keyframes tempGlow{0%,100%{box-shadow:0 0 10px rgba(0,255,255,0.4)}50%{box-shadow:0 0 20px rgba(0,255,255,0.6)}}
.mqtt-status{padding:.5rem;border-radius:6px;text-align:center;font-size:.85rem;margin-bottom:.5rem}
.mqtt-connected{background:rgba(34,209,139,0.2);color:#22d18b}
.mqtt-disconnected{background:rgba(255,68,68,0.2);color:#ff4444}
.voice-panel{margin-top:1rem;padding:1rem;background:rgba(34,209,139,0.1);border-radius:8px}
.voice-btn{padding:.6rem 1rem;border-radius:8px;background:#22d18b;color:#fff;font-weight:bold;cursor:pointer;border:none;width:100%;margin-bottom:.5rem;transition:.3s}
.voice-btn:hover{background:#1ab876;transform:translateY(-2px)}
.voice-btn:disabled{opacity:0.5;cursor:not-allowed}
#voiceResult{margin-top:.5rem;font-size:.9rem;color:#aefeff;min-height:20px}
.device-info{font-size:.75rem;color:#aaa;margin-top:.2rem}
.time-prompt{background:linear-gradient(135deg,rgba(138,43,226,0.15),rgba(75,0,130,0.15));padding:1rem;border-radius:10px;margin-bottom:1rem;border-left:4px solid #8a2be2;box-shadow:0 4px 12px rgba(138,43,226,0.2)}
.time-prompt h3{font-size:.95rem;margin-bottom:.4rem;color:#dda0dd}
.time-prompt p{font-size:.85rem;color:#e6e6fa;line-height:1.4}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.5rem}
.action-btn{padding:.7rem;border-radius:8px;border:none;font-weight:bold;cursor:pointer;transition:all .3s;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:.3rem}
.action-btn.all-on{background:linear-gradient(135deg,#22d18b,#1ab876);color:#fff}
.action-btn.all-on:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(34,209,139,0.4)}
.action-btn.vacation{background:linear-gradient(135deg,#ff4d4d,#cc0000);color:#fff}
.action-btn.vacation:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,77,77,0.4)}
.action-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
.weather-panel{background:linear-gradient(135deg,rgba(33,150,243,0.15),rgba(3,169,244,0.15));padding:1rem;border-radius:10px;margin-bottom:1rem;border-left:4px solid #2196f3;box-shadow:0 4px 12px rgba(33,150,243,0.2)}
.weather-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
.weather-title{font-size:1rem;font-weight:bold;color:#81d4fa}
.weather-refresh{background:rgba(33,150,243,0.3);border:none;padding:.4rem .8rem;border-radius:6px;color:#fff;cursor:pointer;font-size:.8rem;transition:.3s}
.weather-refresh:hover{background:rgba(33,150,243,0.5);transform:scale(1.05)}
.weather-refresh:disabled{opacity:0.5;cursor:not-allowed}
.weather-main{display:flex;align-items:center;gap:1rem;margin-bottom:.8rem}
.weather-temp{font-size:2.5rem;font-weight:bold;color:#fff}
.weather-icon{font-size:3rem;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.weather-condition{font-size:.95rem;color:#b3e5fc;margin-bottom:.3rem}
.weather-details{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.85rem}
.weather-detail{background:rgba(0,0,0,0.2);padding:.5rem;border-radius:6px;display:flex;align-items:center;gap:.4rem}
.weather-detail-icon{font-size:1.2rem}
.weather-detail-text{color:#e1f5fe}
.weather-location{font-size:.8rem;color:#90caf9;margin-top:.5rem;text-align:center}
.weather-update-time{font-size:.75rem;color:#64b5f6;text-align:center;margin-top:.3rem}
.weather-loading{text-align:center;padding:1rem;color:#81d4fa}
.access-denied{background:rgba(255,68,68,0.1);border:2px solid rgba(255,68,68,0.3);padding:1rem;border-radius:8px;color:#ff6b6b;text-align:center;font-weight:600;margin:1rem 0}
.buzzer-pulse{animation:pulseRed 1.2s infinite alternate}
@keyframes pulseRed{from{box-shadow:0 0 6px #ff3333,0 0 12px #ff3333}to{box-shadow:0 0 20px #ff0000,0 0 30px #ff0000}}
</style>
</head>
<body>
<header>
<h1>üè† ESP32 Smart Home Dashboard</h1>
<div class="user-info">
  <div class="user-badge">
    <span class="role-icon" id="roleIcon">üë§</span>
    <span id="userDisplay">Guest</span>
  </div>
  <button class="logout" onclick="handleLogout()">Logout</button>
</div>
</header>

<div class="main">
<div class="panel"><div class="rooms" id="rooms"></div></div>
<div class="panel" style="display:flex;flex-direction:column;gap:12px">
<div class="panel" style="padding:12px">
  <div style="font-size:.95rem">Summary</div>
  <div id="summary" style="font-weight:700;font-size:1.3rem;margin-top:6px">0 ON</div>
  <div class="quick-actions" id="quickActions">
    <button class="action-btn all-on" onclick="sendCommand('all_on')">üí° All ON</button>
    <button class="action-btn vacation" onclick="sendCommand('all_off')">üèñÔ∏è All OFF</button>
  </div>
</div>

<div class="weather-panel" id="weatherPanel">
  <div class="weather-header">
    <div class="weather-title">üå§Ô∏è Weather</div>
    <button class="weather-refresh" id="weatherRefreshBtn" onclick="refreshWeather()">üîÑ Refresh</button>
  </div>
  <div id="weatherContent">
    <div class="weather-loading">‚è≥ Loading weather...</div>
  </div>
</div>

<div class="time-prompt" id="timePrompt"></div>
<div id="mqttArea" class="panel" style="padding:12px;text-align:center">
  <div class="mqtt-status mqtt-disconnected" id="mqttStatus">üî¥ MQTT Disconnected</div>
  <div style="font-size:.8rem;color:#aaa;margin-top:.5rem" id="mqttDetails">Connecting...</div>
</div>
<div class="panel voice-panel" id="voicePanel">
  <h3 style="margin-bottom:.5rem">üéôÔ∏è Voice Command</h3>
  <button class="voice-btn" id="voiceBtn" onclick="startVoiceCommand()">üéôÔ∏è Start Listening</button>
  <button class="voice-btn" id="continuousBtn" onclick="toggleContinuousMode()" style="background:#394651">üîÑ Continuous: OFF</button>
  <div id="voiceResult">Say: "Turn on kitchen light"</div>
</div>
<div class="panel" style="padding:12px"><div style="font-size:.95rem;margin-bottom:6px">Activity Log</div><div class="log" id="logBox"></div></div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<script>
// ========================================
// ROLE-BASED ACCESS CONTROL SYSTEM
// ========================================

let currentUser = {
  username: '',
  role: '',
  fullName: '',
  permissions: {}
};

const ROLE_PERMISSIONS = {
  admin: {
    canControl: true,
    canViewAll: true,
    canUseVoice: true,
    canAccessWeather: true,
    canViewLogs: true,
    canUseQuickActions: true,
    label: 'üëë Administrator',
    color: '#22d18b'
  },
  user: {
    canControl: true,
    canViewAll: true,
    canUseVoice: true,
    canAccessWeather: true,
    canViewLogs: true,
    canUseQuickActions: false,
    label: 'üß∞ Standard User',
    color: '#fbbf24'
  },
  guest: {
    canControl: false,
    canViewAll: true,
    canUseVoice: false,
    canAccessWeather: true,
    canViewLogs: false,
    canUseQuickActions: false,
    label: 'üëÅÔ∏è Guest',
    color: '#94a3b8'
  }
};

function checkAuthentication() {
  const username = sessionStorage.getItem('username');
  const role = sessionStorage.getItem('role');
  const fullName = sessionStorage.getItem('fullName');
  const sessionTimestamp = sessionStorage.getItem('sessionTimestamp');

  if (!username || !role || !sessionTimestamp) {
    window.location.href = 'index.html';
    return false;
  }

  const SESSION_DURATION = 24 * 60 * 60 * 1000;
  const elapsed = Date.now() - parseInt(sessionTimestamp);
  
  if (elapsed > SESSION_DURATION) {
    addLog('‚ö†Ô∏è Session expired. Please login again.');
    setTimeout(() => handleLogout(), 2000);
    return false;
  }

  currentUser = {
    username: username,
    role: role,
    fullName: fullName || username,
    permissions: ROLE_PERMISSIONS[role] || ROLE_PERMISSIONS.guest
  };

  updateUserDisplay();
  applyRoleRestrictions();
  
  return true;
}

function updateUserDisplay() {
  const userDisplay = document.getElementById('userDisplay');
  const roleIcon = document.getElementById('roleIcon');
  const roleConfig = ROLE_PERMISSIONS[currentUser.role];
  
  if (roleConfig) {
    const roleEmoji = roleConfig.label.split(' ')[0];
    roleIcon.textContent = roleEmoji;
    userDisplay.textContent = `${currentUser.username} (${currentUser.role})`;
    userDisplay.style.color = roleConfig.color;
  }

  addLog(`‚úÖ Welcome ${currentUser.fullName} - ${roleConfig.label}`);
  addLog(`üîë Access Level: ${currentUser.role.toUpperCase()}`);
}

function applyRoleRestrictions() {
  const perms = currentUser.permissions;

  if (!perms.canControl) {
    addLog('‚ö†Ô∏è Guest access - Device control disabled');
  }

  const quickActions = document.getElementById('quickActions');
  if (!perms.canUseQuickActions) {
    quickActions.innerHTML = `<div class="access-denied">üîí Quick Actions require Admin role</div>`;
  }

  if (!perms.canUseVoice) {
    document.getElementById('voiceBtn').disabled = true;
    document.getElementById('continuousBtn').disabled = true;
    document.getElementById('voiceResult').innerHTML = `<div style="color:#ff6b6b;text-align:center">üîí Voice commands require User/Admin role</div>`;
  }

  if (!perms.canViewLogs) {
    document.getElementById('logBox').innerHTML = `<p style="color:#ff6b6b;text-align:center">üîí Activity logs require User/Admin role</p>`;
  }

  if (!perms.canAccessWeather) {
    document.getElementById('weatherPanel').style.display = 'none';
  }
}

function handleLogout() {
  addLog('üëã Logging out...');
  
  if(mqttClient && mqttConnected){
    mqttClient.disconnect();
    addLog("üîå Disconnected from MQTT");
  }
  if(reconnectTimer) clearTimeout(reconnectTimer);
  
  sessionStorage.clear();
  
  setTimeout(() => {
    window.location.href = 'index.html';
  }, 1000);
}

// ========================================
// MQTT CONFIGURATION - REAL CONNECTION
// ========================================
const MQTT_HOST = "broker.hivemq.com";
const MQTT_PORT_WSS = 8884;
const MQTT_TOPIC_CONTROL = "smarthome/control";
const MQTT_TOPIC_STATUS = "smarthome/status";
const MQTT_TOPIC_LED_CONTROL = "smarthome/led/control";

let mqttClient = null;
let mqttConnected = false;
let reconnectTimer = null;
let autoRestartEnabled = false;
let recognition = null;
let isListening = false;

const logBox = document.getElementById("logBox");

let weatherData = {
  temperature: 28.5,
  condition: "Clear sky",
  windSpeed: 12.3,
  windDirection: "NE",
  city: "Bengaluru",
  lastUpdate: new Date().toLocaleTimeString(),
  isValid: true
};

const rooms = [
 { name: "Kitchen", devices: [{ id: "kitchen_light", label: "Light", color: "#34d399", state: false, isReal: true }], temperature: 28.5 },
 { name: "Bedroom 1", devices: [{ id: "bed1_light", label: "Light", color: "#ffd166", state: false, isReal: true }]},
 { name: "Living Hall", devices: [{ id: "living_light", label: "Light", color: "#ff4d4d", state: false, isReal: true }]},
 { name: "LED Control", devices: [{ id: "led", label: "LED Strip", color: "#7f8cff", state: false, isReal: true }]},
 { name: "Buzzer Control", devices: [{ id: "buzzer", label: "Buzzer", color: "#ff3333", state: false, isBuzzer: true, isReal: true }]}
];

// ========================================
// MQTT CONNECTION WITH REAL BROKER
// ========================================
function connectMQTT() {
  const clientId = "SmartHomeDashboard_" + Math.random().toString(16).substr(2, 8);
  
  addLog(`üîå Connecting to ${MQTT_HOST}:${MQTT_PORT_WSS}...`);
  document.getElementById("mqttDetails").textContent = `Connecting to ${MQTT_HOST}...`;
  
  mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT_WSS, clientId);

  mqttClient.onConnectionLost = (responseObject) => {
    mqttConnected = false;
    updateMQTTStatus(false);
    addLog(`‚ùå Connection lost: ${responseObject.errorMessage}`);
    
    if(reconnectTimer) clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(connectMQTT, 5000);
  };

  mqttClient.onMessageArrived = (message) => {
    const topic = message.destinationName;
    const payload = message.payloadString;
    
    console.log(`üì• MQTT Message [${topic}]: ${payload}`);
    
    try { 
      const data = JSON.parse(payload);
      updateDeviceStatesFromMQTT(data);
      addLog(`üì• Status updated from ESP32`);
    }
    catch(e) { 
      console.log("Non-JSON message:", payload);
      addLog(`üì• ${topic}: ${payload}`);
    }
  };

  mqttClient.connect({
    useSSL: true,
    timeout: 10,
    keepAliveInterval: 60,
    cleanSession: true,
    onSuccess: () => {
      mqttConnected = true;
      updateMQTTStatus(true);
      addLog("‚úÖ MQTT connected successfully!");
      
      mqttClient.subscribe(MQTT_TOPIC_STATUS);
      mqttClient.subscribe(MQTT_TOPIC_CONTROL);
      addLog(`üì° Subscribed to ${MQTT_TOPIC_STATUS}`);
      
      publishMQTT("status");
      
      document.getElementById("mqttDetails").textContent = `Connected to ${MQTT_HOST}`;
    },
    onFailure: (error) => {
      mqttConnected = false;
      updateMQTTStatus(false);
      addLog(`‚ùå Connection failed: ${error.errorMessage}`);
      document.getElementById("mqttDetails").textContent = `Failed: ${error.errorMessage}`;
      
      if(reconnectTimer) clearTimeout(reconnectTimer);
      reconnectTimer = setTimeout(connectMQTT, 5000);
    }
  });
}

function updateMQTTStatus(connected){
  const s = document.getElementById("mqttStatus");
  s.textContent = connected ? "üü¢ MQTT Connected" : "üî¥ MQTT Disconnected";
  s.className = "mqtt-status " + (connected ? "mqtt-connected" : "mqtt-disconnected");
}

function publishMQTT(cmd){
  if(!mqttConnected || !mqttClient){
    addLog("‚ö†Ô∏è MQTT not connected - cannot send command");
    return false;
  }
  
  try {
    const message = new Paho.MQTT.Message(cmd);
    message.destinationName = MQTT_TOPIC_CONTROL;
    message.qos = 0;
    message.retained = false;
    
    mqttClient.send(message);
    addLog(`üì§ Sent: ${cmd}`);
    console.log(`üì§ Published to ${MQTT_TOPIC_CONTROL}: ${cmd}`);
    return true;
  } catch(e) {
    addLog(`‚ùå Failed to publish: ${e.message}`);
    return false;
  }
}

function updateDeviceStatesFromMQTT(data){
  console.log("Updating device states:", data);
  
  ["living_light", "kitchen_light", "bed1_light", "led", "buzzer"].forEach(id => {
    if(data[id] !== undefined){
      const dev = findDevice(id);
      if(dev){
        const newState = data[id] === "on" || data[id] === true;
        if(dev.state !== newState) {
          dev.state = newState;
          console.log(`Updated ${id} to ${newState}`);
        }
      }
    }
  });
  
  if(data.temperature !== undefined) {
    const kitchen = rooms.find(r => r.name === "Kitchen");
    if(kitchen) {
      kitchen.temperature = parseFloat(data.temperature);
    }
  }
  
  render();
}

function findDevice(id){
  for(const r of rooms){
    const d = r.devices.find(x => x.id === id);
    if(d) return d;
  }
  return null;
}

function addLog(msg){
  if (!currentUser.permissions.canViewLogs) {
    return;
  }

  const t = new Date().toLocaleTimeString();
  const p = document.createElement('p');
  p.textContent = `[${t}] ${msg}`;
  logBox.appendChild(p);
  logBox.scrollTop = logBox.scrollHeight;
  
  while(logBox.children.length > 50) {
    logBox.removeChild(logBox.firstChild);
  }
}

// ========================================
// WEATHER
// ========================================
function getWeatherIcon(condition) {
  if (!condition) return "üå°Ô∏è";
  const c = condition.toLowerCase();
  if (c.includes("clear")) return "‚òÄÔ∏è";
  if (c.includes("partly cloudy")) return "‚õÖ";
  if (c.includes("cloudy")) return "‚òÅÔ∏è";
  if (c.includes("rain")) return "üåßÔ∏è";
  if (c.includes("snow")) return "‚ùÑÔ∏è";
  if (c.includes("thunder")) return "‚õàÔ∏è";
  if (c.includes("fog")) return "üå´Ô∏è";
  return "üå§Ô∏è";
}

function updateWeatherDisplay() {
  const content = document.getElementById("weatherContent");
  
  if (!weatherData.isValid) {
    content.innerHTML = '<div class="weather-loading">‚è≥ Waiting for weather data...</div>';
    return;
  }
  
  const icon = getWeatherIcon(weatherData.condition);
  
  content.innerHTML = `
    <div class="weather-main">
      <div class="weather-icon">${icon}</div>
      <div>
        <div class="weather-temp">${weatherData.temperature.toFixed(1)}¬∞C</div>
        <div class="weather-condition">${weatherData.condition}</div>
      </div>
    </div>
    <div class="weather-details">
      <div class="weather-detail">
        <div class="weather-detail-icon">üí®</div>
        <div class="weather-detail-text">${weatherData.windSpeed.toFixed(1)} km/h</div>
      </div>
      <div class="weather-detail">
        <div class="weather-detail-icon">üß≠</div>
        <div class="weather-detail-text">${weatherData.windDirection}</div>
      </div>
    </div>
    ${weatherData.city ? `<div class="weather-location">üìç ${weatherData.city}</div>` : ''}
    ${weatherData.lastUpdate ? `<div class="weather-update-time">Updated: ${weatherData.lastUpdate}</div>` : ''}
  `;
}

function refreshWeather() {
  if (!currentUser.permissions.canAccessWeather) {
    addLog('‚ùå Access denied - Insufficient permissions');
    return;
  }

  const btn = document.getElementById("weatherRefreshBtn");
  btn.disabled = true;
  btn.textContent = "‚è≥ Refreshing...";
  
  addLog("üå§Ô∏è Fetching weather data...");
  
  setTimeout(() => {
    weatherData.temperature = 25 + Math.random() * 10;
    weatherData.windSpeed = 5 + Math.random() * 20;
    const conditions = ["Clear sky", "Partly cloudy", "Overcast", "Rain", "Thunderstorm"];
    weatherData.condition = conditions[Math.floor(Math.random() * conditions.length)];
    weatherData.lastUpdate = new Date().toLocaleTimeString();
    
    updateWeatherDisplay();
    
    const kitchen = rooms.find(r => r.name === "Kitchen");
    if (kitchen) kitchen.temperature = weatherData.temperature;
    render();
    
    addLog("‚úÖ Weather data updated!");
    btn.disabled = false;
    btn.textContent = "üîÑ Refresh";
  }, 1500);
}

function updateTimePrompt() {
  const now = new Date();
  const hour = now.getHours();
  let icon, greeting, suggestion;
  
  if (hour >= 6 && hour < 12) {
    icon = "‚òÄÔ∏è"; greeting = "Good morning!"; suggestion = "Start your day bright";
  } else if (hour >= 12 && hour < 17) {
    icon = "üçΩÔ∏è"; greeting = "Afternoon!"; suggestion = "Consider kitchen lighting";
  } else if (hour >= 17 && hour < 21) {
    icon = "üåÜ"; greeting = "Evening time!"; suggestion = "Turn on hall light";
  } else {
    icon = "üåô"; greeting = "Night mode"; suggestion = "Consider bedroom light";
  }
  
  document.getElementById("timePrompt").innerHTML = `
    <h3>${icon} ${greeting}, ${currentUser.username}!</h3>
    <p>${suggestion}</p>
  `;
}

// ========================================
// VOICE COMMANDS
// ========================================
function startVoiceCommand() {
  if (!currentUser.permissions.canUseVoice) {
    addLog('‚ùå Voice commands require User or Admin role');
    return;
  }

  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    document.getElementById("voiceResult").textContent = "‚ö†Ô∏è Voice not supported";
    addLog("‚ö†Ô∏è Voice recognition requires Chrome/Edge");
    return;
  }
  
  if (!recognition) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onstart = () => {
      isListening = true;
      document.getElementById("voiceBtn").textContent = "‚èπÔ∏è Stop";
      document.getElementById("voiceBtn").style.background = "#ff4444";
      addLog("üé§ Voice recognition started");
    };
    
    recognition.onresult = (event) => {
      const transcript = Array.from(event.results).map(result => result[0].transcript).join('');
      document.getElementById("voiceResult").textContent = `üé§ Heard: "${transcript}"`;
      processVoiceCommand(transcript.toLowerCase());
    };
    
    recognition.onerror = (event) => {
      isListening = false;
      document.getElementById("voiceBtn").textContent = "üéôÔ∏è Start Listening";
      document.getElementById("voiceBtn").style.background = "#22d18b";
      addLog(`‚ö†Ô∏è Voice error: ${event.error}`);
    };
    
    recognition.onend = () => {
      isListening = false;
      document.getElementById("voiceBtn").textContent = "üéôÔ∏è Start Listening";
      document.getElementById("voiceBtn").style.background = "#22d18b";
    };
  }
  
  if (isListening) {
    recognition.stop();
  } else {
    try {
      recognition.start();
    } catch (e) {
      addLog("‚ö†Ô∏è Voice recognition error");
    }
  }
}

function toggleContinuousMode() {
  if (!currentUser.permissions.canUseVoice) {
    addLog('‚ùå Voice commands require User or Admin role');
    return;
  }

  autoRestartEnabled = !autoRestartEnabled;
  const btn = document.getElementById("continuousBtn");
  
  if (autoRestartEnabled) {
    btn.textContent = "üîÑ Continuous: ON";
    btn.style.background = "#22d18b";
    addLog("üîÑ Continuous voice mode enabled");
  } else {
    btn.textContent = "üîÑ Continuous: OFF";
    btn.style.background = "#394651";
    addLog("‚è∏Ô∏è Continuous voice mode disabled");
  }
}

function processVoiceCommand(input) {
  let command = null;
  
  if(input.includes("kitchen") && (input.includes("on") || input.includes("turn on"))) 
    command = "kitchen_light_on";
  else if(input.includes("kitchen") && (input.includes("off") || input.includes("turn off"))) 
    command = "kitchen_light_off";
  else if(input.includes("bedroom") && (input.includes("on") || input.includes("turn on"))) 
    command = "bed1_light_on";
  else if(input.includes("bedroom") && (input.includes("off") || input.includes("turn off"))) 
    command = "bed1_light_off";
  else if(input.includes("living") && (input.includes("on") || input.includes("turn on"))) 
    command = "living_light_on";
  else if(input.includes("living") && (input.includes("off") || input.includes("turn off"))) 
    command = "living_light_off";
  else if(input.includes("led") && (input.includes("on") || input.includes("turn on"))) 
    command = "led_on";
  else if(input.includes("led") && (input.includes("off") || input.includes("turn off"))) 
    command = "led_off";
  else if(input.includes("all") && (input.includes("on") || input.includes("turn on"))) 
    command = "all_on";
  else if(input.includes("all") && (input.includes("off") || input.includes("turn off"))) 
    command = "all_off";
  else if(input.includes("buzzer") || input.includes("alarm")) 
    command = "buzzer_on";
  else if(input.includes("weather"))
    command = "weather_update";
  
  if(command){
    document.getElementById("voiceResult").textContent = `‚úÖ Executing: ${command}`;
    sendCommand(command);
  } else {
    document.getElementById("voiceResult").textContent = `‚ùì Unknown: "${input}"`;
    addLog(`‚ùì Unknown voice command: "${input}"`);
  }
}

// ========================================
// DEVICE CONTROL
// ========================================
function sendCommand(cmd) {
  if ((cmd !== 'weather_update') && !currentUser.permissions.canControl) {
    addLog(`‚ùå Access denied - ${currentUser.role} cannot control devices`);
    alert('üîí You do not have permission to control devices.');
    return;
  }

  if ((cmd === 'all_on' || cmd === 'all_off') && !currentUser.permissions.canUseQuickActions) {
    addLog(`‚ùå Access denied - Quick actions require Admin role`);
    alert('üîí Quick actions are restricted to Administrators only.');
    return;
  }

  if (cmd === "weather_update") {
    refreshWeather();
    return;
  }

  addLog(`üì§ ${currentUser.username} sent: ${cmd}`);
  
  if(publishMQTT(cmd)){
    if (cmd === "all_on") {
      rooms.forEach(r => r.devices.forEach(d => { if (!d.isBuzzer) d.state = true; }));
    } else if (cmd === "all_off") {
      rooms.forEach(r => r.devices.forEach(d => { if (!d.isBuzzer) d.state = false; }));
    } else if (cmd === "buzzer_on") {
      const buzzer = findDevice("buzzer");
      if(buzzer) buzzer.state = true;
      addLog("üîî Buzzer activated!");
      setTimeout(() => {
        if(buzzer) buzzer.state = false;
        render();
      }, 2000);
    } else {
      const parts = cmd.split('_');
      const deviceId = parts.slice(0, -1).join('_');
      const action = parts[parts.length - 1];
      
      const dev = findDevice(deviceId);
      if(dev) {
        dev.state = (action === "on");
      }
    }
    
    render();
    updateSummary();
  }
}

function render() {
  const div = document.getElementById("rooms");
  div.innerHTML = "";
  let onCount = 0;
  
  rooms.forEach(r => {
    const card = document.createElement("div");
    card.className = "room";
    const h = document.createElement("h2");
    h.textContent = r.name;
    card.appendChild(h);
    
    r.devices.forEach(d => {
      const dv = document.createElement("div");
      dv.className = "device";
      
      const ind = document.createElement("div");
      ind.className = "indicator " + (d.state ? "" : "off");
      ind.style.background = d.state ? d.color : "";
      
      if(d.label === "Light") ind.textContent = "üí°";
      else if(d.isBuzzer) ind.textContent = "üîî";
      else if(d.id === "led") ind.textContent = "üåà";
      
      const lbl = document.createElement("div");
      lbl.innerHTML = d.label + ' <span class="device-info">ESP32</span>';
      
      const tg = document.createElement("div");
      tg.className = "toggle " + (d.state ? "on" : "");
      
      if (!currentUser.permissions.canControl) {
        tg.classList.add('disabled');
      } else {
        tg.onclick = () => {
          const newState = !d.state;
          const cmd = `${d.id}_${newState ? "on" : "off"}`;
          sendCommand(cmd);
        };
      }
      
      dv.appendChild(ind);
      dv.appendChild(lbl);
      dv.appendChild(tg);
      card.appendChild(dv);
      
      if(d.state && !d.isBuzzer) onCount++;
    });
    
    if(r.name === "Kitchen" && r.temperature !== undefined) {
      const t = document.createElement("div");
      t.className = "temp-panel";
      t.textContent = `üå°Ô∏è ${r.temperature.toFixed(1)} ¬∞C`;
      card.appendChild(t);
    }
    
    div.appendChild(card);
  });
  
  document.getElementById("summary").textContent = `${onCount} ON`;
}

function updateSummary(){
  let onCount = 0;
  rooms.forEach(r => r.devices.forEach(d => {
    if(d.state && !d.isBuzzer) onCount++;
  }));
  
  const e = document.getElementById("summary");
  e.textContent = `${onCount} ON`;
}

function requestStatus() {
  if(mqttConnected) {
    publishMQTT("status");
  }
}

// ========================================
// INITIALIZATION
// ========================================
if (checkAuthentication()) {
  render();
  updateTimePrompt();
  updateWeatherDisplay();
  connectMQTT();
  
  setInterval(updateTimePrompt, 60000);
  setInterval(requestStatus, 30000);

  addLog("üöÄ Dashboard initialized");
  addLog(`üìç Broker: ${MQTT_HOST}:${MQTT_PORT_WSS}`);
  addLog(`üì° Topics: ${MQTT_TOPIC_CONTROL}, ${MQTT_TOPIC_STATUS}`);
  
  if (currentUser.permissions.canControl) {
    addLog("üí° Click toggles or use voice commands");
  } else {
    addLog("üëÅÔ∏è View-only mode - Device control disabled");
  }
}
</script>
</body>
</html>
