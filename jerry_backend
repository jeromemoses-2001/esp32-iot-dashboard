const char HTML_PAGE[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>üè† ESP32 Smart Home Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif}
body{background:linear-gradient(-45deg,#05142d,#08284b,#08386c,#0a4e80);background-size:400% 400%;animation:bgmove 10s ease infinite;color:#fff;min-height:100vh;display:flex;flex-direction:column}
@keyframes bgmove{0%{background-position:0%50%}50%{background-position:100%50%}100%{background-position:0%50%}}
header{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:rgba(255,255,255,0.04);backdrop-filter:blur(6px)}
h1{font-size:1.2rem;display:flex;align-items:center;gap:10px}
.user-info{font-size:.9rem;color:#dbeef7}
.logout{background:#f44;color:#fff;border:none;padding:.4rem 1rem;border-radius:.4rem;cursor:pointer;transition:.3s}
.logout:hover{background:#ff6666}
.main{flex:1;padding:1.5rem 2rem;display:grid;grid-template-columns:1fr 360px;gap:1rem;align-items:start}
@media(max-width:980px){.main{grid-template-columns:1fr}}
.panel{background:rgba(255,255,255,0.03);padding:1rem;border-radius:12px;backdrop-filter:blur(6px)}
.rooms{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
.room{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:1rem;border-radius:10px;transition:transform .2s;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
.room:hover{transform:translateY(-6px)}
.room h2{margin-bottom:.6rem;font-size:1.1rem}
.device{display:flex;align-items:center;justify-content:space-between;padding:.6rem;border-radius:8px;background:rgba(0,0,0,0.15);margin-bottom:.6rem}
.indicator{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;color:#06121a;font-weight:700;transition:all .3s}
.indicator.off{background:#394651;color:#9fb0c9}
.toggle{width:46px;height:26px;border-radius:20px;background:#24323f;position:relative;cursor:pointer;transition:all .3s}
.toggle.disabled{opacity:0.4;cursor:not-allowed}
.toggle::before{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#dbeef7;top:4px;left:4px;transition:all .18s}
.toggle.on{background:linear-gradient(90deg,#22d18b,#00b894)}
.toggle.on::before{left:24px;background:#fff}
.toggle:hover:not(.disabled){transform:scale(1.05)}
.log{margin-top:1rem;background:rgba(255,165,0,0.12);padding:.8rem;border-radius:8px;max-height:160px;overflow:auto;border-top:3px solid rgba(255,165,0,0.6);font-size:.85rem}
.log p{margin:.25rem 0;color:#fff}
.temp-panel{margin-top:8px;padding:6px 10px;border-radius:8px;text-align:center;background:rgba(0,255,255,0.08);box-shadow:0 0 10px rgba(0,255,255,0.4);font-size:.9rem;color:#aefeff;font-weight:600;animation:tempGlow 2s ease-in-out infinite}
@keyframes tempGlow{0%,100%{box-shadow:0 0 10px rgba(0,255,255,0.4)}50%{box-shadow:0 0 20px rgba(0,255,255,0.6)}}
.mqtt-status{padding:.5rem;border-radius:6px;text-align:center;font-size:.85rem;margin-bottom:.5rem}
.mqtt-connected{background:rgba(34,209,139,0.2);color:#22d18b}
.mqtt-disconnected{background:rgba(255,68,68,0.2);color:#ff4444}
.voice-panel{margin-top:1rem;padding:1rem;background:rgba(34,209,139,0.1);border-radius:8px}
.voice-btn{padding:.6rem 1rem;border-radius:8px;background:#22d18b;color:#fff;font-weight:bold;cursor:pointer;border:none;width:100%;margin-bottom:.5rem;transition:.3s}
.voice-btn:hover{background:#1ab876;transform:translateY(-2px)}
#voiceResult{margin-top:.5rem;font-size:.9rem;color:#aefeff;min-height:20px}
.device-info{font-size:.75rem;color:#aaa;margin-top:.2rem}
.listening-pulse{animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.time-prompt{background:linear-gradient(135deg,rgba(138,43,226,0.15),rgba(75,0,130,0.15));padding:1rem;border-radius:10px;margin-bottom:1rem;border-left:4px solid #8a2be2;box-shadow:0 4px 12px rgba(138,43,226,0.2)}
.time-prompt h3{font-size:.95rem;margin-bottom:.4rem;color:#dda0dd}
.time-prompt p{font-size:.85rem;color:#e6e6fa;line-height:1.4}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.5rem}
.action-btn{padding:.7rem;border-radius:8px;border:none;font-weight:bold;cursor:pointer;transition:all .3s;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:.3rem}
.action-btn.all-on{background:linear-gradient(135deg,#22d18b,#1ab876);color:#fff}
.action-btn.all-on:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(34,209,139,0.4)}
.action-btn.vacation{background:linear-gradient(135deg,#ff4d4d,#cc0000);color:#fff}
.action-btn.vacation:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,77,77,0.4)}
.action-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
.weather-panel{background:linear-gradient(135deg,rgba(33,150,243,0.15),rgba(3,169,244,0.15));padding:1rem;border-radius:10px;margin-bottom:1rem;border-left:4px solid #2196f3;box-shadow:0 4px 12px rgba(33,150,243,0.2)}
.weather-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
.weather-title{font-size:1rem;font-weight:bold;color:#81d4fa}
.weather-refresh{background:rgba(33,150,243,0.3);border:none;padding:.4rem .8rem;border-radius:6px;color:#fff;cursor:pointer;font-size:.8rem;transition:.3s}
.weather-refresh:hover{background:rgba(33,150,243,0.5);transform:scale(1.05)}
.weather-refresh:disabled{opacity:0.5;cursor:not-allowed}
.weather-main{display:flex;align-items:center;gap:1rem;margin-bottom:.8rem}
.weather-temp{font-size:2.5rem;font-weight:bold;color:#fff}
.weather-icon{font-size:3rem;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.weather-condition{font-size:.95rem;color:#b3e5fc;margin-bottom:.3rem}
.weather-details{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.85rem}
.weather-detail{background:rgba(0,0,0,0.2);padding:.5rem;border-radius:6px;display:flex;align-items:center;gap:.4rem}
.weather-detail-icon{font-size:1.2rem}
.weather-detail-text{color:#e1f5fe}
.weather-location{font-size:.8rem;color:#90caf9;margin-top:.5rem;text-align:center}
.weather-update-time{font-size:.75rem;color:#64b5f6;text-align:center;margin-top:.3rem}
.weather-loading{text-align:center;padding:1rem;color:#81d4fa}
</style>
</head>
<body>
<header>
<h1>üè† ESP32 Smart Home Dashboard</h1>
<div class="user-info" id="userInfo"></div>
<button class="logout" id="logoutBtn">Logout</button>
</header>

<div class="main">
<div class="panel"><div class="rooms" id="rooms"></div></div>
<div class="panel" style="display:flex;flex-direction:column;gap:12px">
<div class="panel" style="padding:12px">
  <div style="font-size:.95rem">Summary</div>
  <div id="summary" style="font-weight:700;font-size:1.3rem;margin-top:6px">0 ON</div>
  <div class="quick-actions">
    <button class="action-btn all-on" onclick="sendCommand('all_on')">üí° All ON</button>
    <button class="action-btn vacation" onclick="sendCommand('all_off')">üèñÔ∏è All OFF</button>
  </div>
</div>

<div class="weather-panel" id="weatherPanel">
  <div class="weather-header">
    <div class="weather-title">üå§Ô∏è Weather</div>
    <button class="weather-refresh" id="weatherRefreshBtn" onclick="refreshWeather()">üîÑ Refresh</button>
  </div>
  <div id="weatherContent">
    <div class="weather-loading">‚è≥ Loading weather...</div>
  </div>
</div>

<div class="time-prompt" id="timePrompt"></div>
<div id="mqttArea" class="panel" style="padding:12px;text-align:center">
  <div class="mqtt-status mqtt-disconnected" id="mqttStatus">üî¥ MQTT Disconnected</div>
  <div style="font-size:.8rem;color:#aaa;margin-top:.5rem" id="mqttDetails">Connecting...</div>
</div>
<div class="panel voice-panel">
  <h3 style="margin-bottom:.5rem">üéôÔ∏è Voice Command</h3>
  <button class="voice-btn" id="voiceBtn" onclick="startVoiceCommand()">üéôÔ∏è Start Listening</button>
  <button class="voice-btn" id="continuousBtn" onclick="toggleContinuousMode()" style="background:#394651">üîÑ Continuous: OFF</button>
  <div id="voiceResult">Say: "Turn on kitchen light"</div>
</div>
<div class="panel" style="padding:12px"><div style="font-size:.95rem;margin-bottom:6px">Activity Log</div><div class="log" id="logBox"></div></div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<script>
const MQTT_HOST = "broker.hivemq.com";
const MQTT_PORT_WSS = 8884;
const MQTT_TOPIC_CONTROL = "smarthome/control";
const MQTT_TOPIC_STATUS = "smarthome/status";

let mqttClient = null;
let mqttConnected = false;
let reconnectTimer = null;
let pendingCommands = new Set();

let weatherData = {
  temperature: null,
  condition: null,
  windSpeed: null,
  windDirection: null,
  city: null,
  lastUpdate: null,
  isValid: false
};

let recognition = null;
let isListening = false;
let listeningTimeout = null;
let autoRestartEnabled = false;

const username = localStorage.getItem("username");
const role = localStorage.getItem("role");

if (!username || !role) {
  window.location.href = "index.html";
}

document.getElementById("userInfo").textContent = `${role.charAt(0).toUpperCase() + role.slice(1)} (${username})`;

const logBox = document.getElementById("logBox");

const rooms = [
 { name: "Kitchen", devices: [{ id: "kitchen_light", label: "Light", color: "#34d399", state: false, isReal: true }], temperature: null },
 { name: "Bedroom 1", devices: [{ id: "bed1_light", label: "Light", color: "#ffd166", state: false, isReal: true }]},
 { name: "Living Hall", devices: [{ id: "living_light", label: "Light", color: "#ff4d4d", state: false, isReal: true }]},
 { name: "Buzzer Control", devices: [{ id: "buzzer", label: "Buzzer", color: "#ff3333", state: false, isBuzzer: true, isReal: true }]}
];

function getWeatherIcon(condition) {
  if (!condition) return "üå°Ô∏è";
  const c = condition.toLowerCase();
  if (c.includes("clear")) return "‚òÄÔ∏è";
  if (c.includes("partly cloudy") || c.includes("mainly clear")) return "‚õÖ";
  if (c.includes("cloudy") || c.includes("overcast")) return "‚òÅÔ∏è";
  if (c.includes("rain") || c.includes("drizzle")) return "üåßÔ∏è";
  if (c.includes("snow")) return "‚ùÑÔ∏è";
  if (c.includes("thunder")) return "‚õàÔ∏è";
  if (c.includes("fog")) return "üå´Ô∏è";
  return "üå§Ô∏è";
}

function updateWeatherDisplay() {
  const content = document.getElementById("weatherContent");
  
  if (!weatherData.isValid) {
    content.innerHTML = '<div class="weather-loading">‚è≥ Waiting for weather data...</div>';
    return;
  }
  
  const icon = getWeatherIcon(weatherData.condition);
  
  content.innerHTML = `
    <div class="weather-main">
      <div class="weather-icon">${icon}</div>
      <div>
        <div class="weather-temp">${weatherData.temperature.toFixed(1)}¬∞C</div>
        <div class="weather-condition">${weatherData.condition}</div>
      </div>
    </div>
    <div class="weather-details">
      <div class="weather-detail">
        <div class="weather-detail-icon">üí®</div>
        <div class="weather-detail-text">${weatherData.windSpeed.toFixed(1)} km/h</div>
      </div>
      <div class="weather-detail">
        <div class="weather-detail-icon">üß≠</div>
        <div class="weather-detail-text">${weatherData.windDirection}</div>
      </div>
    </div>
    ${weatherData.city ? `<div class="weather-location">üìç ${weatherData.city}</div>` : ''}
    ${weatherData.lastUpdate ? `<div class="weather-update-time">Updated: ${weatherData.lastUpdate}</div>` : ''}
  `;
}

function refreshWeather() {
  if (!mqttConnected) {
    addLog("‚ö†Ô∏è MQTT not connected - cannot refresh weather");
    return;
  }
  
  const btn = document.getElementById("weatherRefreshBtn");
  btn.disabled = true;
  btn.textContent = "‚è≥ Refreshing...";
  
  sendCommand("weather_update");
  addLog("üå§Ô∏è Requesting weather update from ESP32...");
  
  setTimeout(() => {
    btn.disabled = false;
    btn.textContent = "üîÑ Refresh";
  }, 10000);
}

function updateTimePrompt() {
  const now = new Date();
  const hour = now.getHours();
  let icon, greeting, suggestion;
  
  if (hour >= 6 && hour < 12) {
    icon = "‚òÄÔ∏è";
    greeting = "Good morning!";
    suggestion = "Start your day bright";
  } else if (hour >= 12 && hour < 17) {
    icon = "üçΩÔ∏è";
    greeting = "Afternoon!";
    suggestion = "Consider kitchen lighting";
  } else if (hour >= 17 && hour < 21) {
    icon = "üåÜ";
    greeting = "Evening time!";
    suggestion = "Turn on hall light";
  } else {
    icon = "üåô";
    greeting = "Night mode";
    suggestion = "Consider bedroom light";
  }
  
  const promptDiv = document.getElementById("timePrompt");
  promptDiv.innerHTML = `
    <h3>${icon} ${greeting}</h3>
    <p>${suggestion}</p>
  `;
}

function initVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return null;
  }
  
  const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recog.lang = 'en-US';
  recog.continuous = false;
  recog.interimResults = true;
  recog.maxAlternatives = 3;
  
  recog.onstart = () => {
    isListening = true;
    updateVoiceUI('listening');
    addLog("üé§ Voice recognition started");
    
    listeningTimeout = setTimeout(() => {
      if (isListening) {
        recog.stop();
        addLog("‚è±Ô∏è Voice timeout (10s)");
      }
    }, 10000);
  };
  
  recog.onresult = (event) => {
    if (listeningTimeout) clearTimeout(listeningTimeout);
    
    const interim = Array.from(event.results)
      .filter(result => !result.isFinal)
      .map(result => result[0].transcript)
      .join(' ');
    
    if (interim) {
      document.getElementById("voiceResult").textContent = `üé§ Hearing: "${interim}..."`;
    }
    
    const final = Array.from(event.results)
      .filter(result => result.isFinal)
      .map(result => result[0].transcript)
      .join(' ');
    
    if (final) {
      const voiceInput = final.toLowerCase().trim();
      document.getElementById("voiceResult").textContent = `üé§ Heard: "${voiceInput}"`;
      addLog(`üé§ Heard: "${voiceInput}"`);
      
      const success = processVoiceCommand(voiceInput);
      
      if (autoRestartEnabled && success) {
        setTimeout(() => {
          if (!isListening) startVoiceCommand();
        }, 2000);
      }
    }
  };
  
  recog.onerror = (event) => {
    isListening = false;
    updateVoiceUI('error');
    if (listeningTimeout) clearTimeout(listeningTimeout);
    
    let errorMsg = 'Error';
    if (event.error === 'no-speech') {
      errorMsg = 'No speech detected';
      if (autoRestartEnabled) setTimeout(() => startVoiceCommand(), 1500);
    } else if (event.error === 'not-allowed') {
      errorMsg = 'Microphone permission denied';
      autoRestartEnabled = false;
      document.getElementById("continuousBtn").textContent = "üîÑ Continuous: OFF";
      document.getElementById("continuousBtn").style.background = "#394651";
    }
    
    addLog(`üé§ ${errorMsg}`);
    document.getElementById("voiceResult").textContent = `‚ö†Ô∏è ${errorMsg}`;
  };
  
  recog.onend = () => {
    isListening = false;
    updateVoiceUI('idle');
    if (listeningTimeout) clearTimeout(listeningTimeout);
    
    if (autoRestartEnabled) {
      setTimeout(() => startVoiceCommand(), 1000);
    }
  };
  
  return recog;
}

function startVoiceCommand() {
  if (!recognition) {
    recognition = initVoiceRecognition();
    if (!recognition) {
      document.getElementById("voiceResult").textContent = "‚ö†Ô∏è Voice not supported";
      addLog("‚ö†Ô∏è Voice recognition not supported");
      return;
    }
  }
  
  if (isListening) {
    recognition.stop();
    return;
  }
  
  try {
    recognition.start();
  } catch (e) {
    console.error("Recognition error:", e);
    isListening = false;
    updateVoiceUI('error');
  }
}

function toggleContinuousMode() {
  autoRestartEnabled = !autoRestartEnabled;
  const btn = document.getElementById("continuousBtn");
  
  if (autoRestartEnabled) {
    btn.textContent = "üîÑ Continuous: ON";
    btn.style.background = "#22d18b";
    addLog("üîÑ Continuous mode enabled");
    if (!isListening) startVoiceCommand();
  } else {
    btn.textContent = "üîÑ Continuous: OFF";
    btn.style.background = "#394651";
    addLog("‚è∏Ô∏è Continuous mode disabled");
    if (isListening) recognition.stop();
  }
}

function updateVoiceUI(state) {
  const btn = document.getElementById("voiceBtn");
  const result = document.getElementById("voiceResult");
  
  switch(state) {
    case 'listening':
      btn.textContent = "‚èπÔ∏è Stop";
      btn.style.background = "#ff4444";
      btn.classList.add('listening-pulse');
      break;
    case 'idle':
      btn.textContent = "üéôÔ∏è Start Listening";
      btn.style.background = "#22d18b";
      btn.classList.remove('listening-pulse');
      break;
    case 'error':
      btn.textContent = "üéôÔ∏è Start Listening";
      btn.style.background = "#22d18b";
      btn.classList.remove('listening-pulse');
      break;
  }
}

function processVoiceCommand(input) {
  const patterns = {
    'kitchen_light_on': [/kitchen.*on/, /turn on.*kitchen/],
    'kitchen_light_off': [/kitchen.*off/, /turn off.*kitchen/],
    'bed1_light_on': [/bed(room)?.*on/, /turn on.*bed/],
    'bed1_light_off': [/bed(room)?.*off/, /turn off.*bed/],
    'living_light_on': [/living.*on/, /hall.*on/],
    'living_light_off': [/living.*off/, /hall.*off/],
    'all_on': [/all.*on/, /everything.*on/],
    'all_off': [/all.*off/, /everything.*off/, /vacation/],
    'buzzer_on': [/buzz(er)?/, /alarm/],
    'weather_update': [/weather/, /refresh weather/]
  };
  
  let command = null;
  for (const [cmd, regexList] of Object.entries(patterns)) {
    for (const regex of regexList) {
      if (regex.test(input)) {
        command = cmd;
        break;
      }
    }
    if (command) break;
  }
  
  if (command) {
    document.getElementById("voiceResult").textContent = `‚úÖ ${command.replace(/_/g, ' ')}`;
    sendCommand(command);
    return true;
  } else {
    document.getElementById("voiceResult").textContent = `‚ùì Unknown: "${input}"`;
    addLog(`‚ùì Unknown: "${input}"`);
    return false;
  }
}

function sendCommand(cmd) {
  if (!mqttConnected || !mqttClient) {
    addLog("‚ö†Ô∏è MQTT not connected");
    return false;
  }
  
  if (role === "guest") {
    addLog("‚ö†Ô∏è Guest cannot control devices");
    return false;
  }
  
  try {
    const message = new Paho.MQTT.Message(cmd);
    message.destinationName = MQTT_TOPIC_CONTROL;
    message.qos = 0;
    message.retained = false;
    mqttClient.send(message);
    
    pendingCommands.add(cmd);
    addLog(`üì§ Sent: ${cmd}`);
    
    setTimeout(() => pendingCommands.delete(cmd), 3000);
    
    disableToggles(true);
    setTimeout(() => disableToggles(false), 500);
    
    return true;
  } catch(e) {
    addLog(`‚ùå Failed: ${e.message}`);
    return false;
  }
}

function disableToggles(disabled) {
  document.querySelectorAll('.toggle').forEach(toggle => {
    if (disabled) {
      toggle.classList.add('disabled');
      toggle.style.pointerEvents = 'none';
    } else {
      toggle.classList.remove('disabled');
      toggle.style.pointerEvents = 'auto';
    }
  });
}

function connectMQTT() {
  const clientId = "ESP32Dashboard_" + Math.random().toString(16).substr(2, 8);
  addLog(`üîå Connecting to ${MQTT_HOST}...`);
  document.getElementById("mqttDetails").textContent = `Connecting...`;
  
  mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT_WSS, clientId);

  mqttClient.onConnectionLost = (responseObject) => {
    mqttConnected = false;
    updateMQTTStatus(false);
    addLog(`‚ùå Connection lost`);
    if(reconnectTimer) clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(connectMQTT, 5000);
  };

  mqttClient.onMessageArrived = (message) => {
    const topic = message.destinationName;
    const payload = message.payloadString;
    console.log(`üì• [${topic}]: ${payload}`);
    
    try { 
      const data = JSON.parse(payload);
      updateDeviceStatesFromMQTT(data);
      updateWeatherFromMQTT(data);
      addLog(`üì• Status updated`);
    } catch(e) { 
      console.log("Non-JSON:", payload);
    }
  };

  mqttClient.connect({
    useSSL: true,
    timeout: 10,
    keepAliveInterval: 60,
    cleanSession: true,
    onSuccess: () => {
      mqttConnected = true;
      updateMQTTStatus(true);
      addLog("‚úÖ MQTT connected!");
      
      mqttClient.subscribe(MQTT_TOPIC_STATUS);
      mqttClient.subscribe(MQTT_TOPIC_CONTROL);
      
      sendCommand("status");
      document.getElementById("mqttDetails").textContent = `${MQTT_HOST}`;
    },
    onFailure: (error) => {
      mqttConnected = false;
      updateMQTTStatus(false);
      addLog(`‚ùå Failed: ${error.errorMessage}`);
      document.getElementById("mqttDetails").textContent = `Failed`;
      if(reconnectTimer) clearTimeout(reconnectTimer);
      reconnectTimer = setTimeout(connectMQTT, 5000);
    }
  });
}

function updateMQTTStatus(connected){
  const s = document.getElementById("mqttStatus");
  s.textContent = connected ? "üü¢ MQTT Connected" : "üî¥ MQTT Disconnected";
  s.className = "mqtt-status " + (connected ? "mqtt-connected" : "mqtt-disconnected");
}

function updateDeviceStatesFromMQTT(data) {
  let stateChanged = false;
  
  ["living_light", "kitchen_light", "bed1_light", "buzzer"].forEach(id => {
    if (data[id] !== undefined) {
      const dev = findDevice(id);
      if (dev) {
        const newState = data[id] === "on" || data[id] === true;
        if (dev.state !== newState) {
          dev.state = newState;
          stateChanged = true;
        }
      }
    }PContinue});
if (data.temperature !== undefined) {
const kitchen = rooms.find(r => r.name === "Kitchen");
if (kitchen) {
kitchen.temperature = parseFloat(data.temperature);
stateChanged = true;
}
}
if (stateChanged) {
render();
}
}
function updateWeatherFromMQTT(data) {
let weatherUpdated = false;
if (data.temperature !== undefined) {
weatherData.temperature = parseFloat(data.temperature);
weatherUpdated = true;
}
if (data.weather_condition !== undefined) {
weatherData.condition = data.weather_condition;
weatherUpdated = true;
}
if (data.wind_speed !== undefined) {
weatherData.windSpeed = parseFloat(data.wind_speed);
weatherUpdated = true;
}
if (data.wind_direction !== undefined) {
weatherData.windDirection = data.wind_direction;
weatherUpdated = true;
}
if (data.city !== undefined) {
weatherData.city = data.city;
weatherUpdated = true;
}
if (data.weather_update !== undefined) {
weatherData.lastUpdate = data.weather_update;
weatherUpdated = true;
}
if (weatherUpdated) {
weatherData.isValid = true;
updateWeatherDisplay();
}
}
function findDevice(id) {
for (const room of rooms) {
for (const device of room.devices) {
if (device.id === id) return device;
}
}
return null;
}
function addLog(msg) {
const p = document.createElement("p");
const now = new Date();
const time = now.toLocaleTimeString();
p.textContent = [${time}] ${msg};
logBox.insertBefore(p, logBox.firstChild);
while (logBox.children.length > 20) {
logBox.removeChild(logBox.lastChild);
}
}
function render() {
const container = document.getElementById("rooms");
container.innerHTML = "";
let onCount = 0;
rooms.forEach(room => {
const roomDiv = document.createElement("div");
roomDiv.className = "room";
let roomHTML = `<h2>${room.name}</h2>`;

room.devices.forEach(device => {
  if (device.state) onCount++;
  
  const indicatorClass = device.state ? "" : "off";
  const toggleClass = device.state ? "on" : "";
  const indicatorColor = device.state ? device.color : "#394651";
  
  roomHTML += `
    <div class="device">
      <div>
        <div style="font-weight:600">${device.label}</div>
        ${device.isReal ? '<div class="device-info">Hardware</div>' : '<div class="device-info">Virtual</div>'}
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="indicator ${indicatorClass}" style="background:${indicatorColor}">
          ${device.isBuzzer ? "üîî" : "üí°"}
        </div>
        <div class="toggle ${toggleClass}" onclick="toggleDevice('${device.id}')"></div>
      </div>
    </div>
  `;
});

if (room.temperature !== null && room.temperature !== undefined) {
  roomHTML += `<div class="temp-panel">üå°Ô∏è ${room.temperature.toFixed(1)}¬∞C</div>`;
}

roomDiv.innerHTML = roomHTML;
container.appendChild(roomDiv);
});
document.getElementById("summary").textContent = ${onCount} ON;
}
function toggleDevice(id) {
const device = findDevice(id);
if (!device) return;
const newState = !device.state;
const command = ${id}_${newState ? 'on' : 'off'};
sendCommand(command);
}
document.getElementById("logoutBtn").addEventListener("click", () => {
localStorage.removeItem("username");
localStorage.removeItem("role");
window.location.href = "index.html";
});
updateTimePrompt();
setInterval(updateTimePrompt, 60000);
connectMQTT();
render();
</script>
</body>
</html>
)rawliteral";
#endif // CONFIG_H
